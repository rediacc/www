---
import { getCollection } from 'astro:content';
import type { Language } from '../i18n/types';
import { createTranslator } from '../i18n/utils';

interface Props {
  currentLang: Language;
  currentUrl: string;
}

const { currentLang, currentUrl } = Astro.props;

// Fetch all docs for navigation
const allDocs = await getCollection('docs');
const docs = allDocs
  .filter((doc) => doc.data.language === currentLang)
  .sort((a, b) => {
    const categorySort = (a.data.category || 'other').localeCompare(
      b.data.category || 'other'
    );
    if (categorySort !== 0) return categorySort;
    return (a.data.order ?? 999) - (b.data.order ?? 999);
  });

// Extract base slug helper function (removes language prefix)
const getBaseSlug = (slug: string) => {
  const parts = slug.split('/');
  return parts.length > 1 ? parts[parts.length - 1] : slug;
};

// Group docs by category
const docsByCategory = docs.reduce((acc, doc) => {
  const category = doc.data.category || 'Other';
  if (!acc[category]) acc[category] = [];
  acc[category].push(doc);
  return acc;
}, {} as Record<string, typeof docs>);

const categories = Object.keys(docsByCategory).sort();

// Get current doc slug for active state
const currentSlug = currentUrl.split('/').pop();

// Get translator
const { t } = createTranslator(currentLang);

// Pre-calculate category states to avoid JSX parsing issues
const categoryStates = categories.map(category => {
  const itemCount = docsByCategory[category].length;
  const categoryId = `category-${category.toLowerCase().replace(/\s+/g, '-')}`;
  const hasActiveDoc = docsByCategory[category].some(doc => {
    const docSlug = getBaseSlug(doc.slug);
    return docSlug === currentSlug;
  });
  const isSmall = itemCount <= 3;
  const initialExpanded = hasActiveDoc || isSmall;

  return {
    category,
    itemCount,
    categoryId,
    hasActiveDoc,
    expandedAttr: initialExpanded ? 'true' : 'false'
  };
});
---

<aside class="docs-sidebar">
  <nav class="docs-nav">
    <h2 class="nav-title">{t('pages.docs.title')}</h2>
    <ul class="category-list">
      {categoryStates.map(({ category, itemCount, categoryId, hasActiveDoc, expandedAttr }) => {

        return (
          <li
            class="category-item"
            data-category={category}
            data-item-count={String(itemCount)}
            data-is-active={hasActiveDoc ? 'true' : 'false'}
            aria-expanded={expandedAttr}
          >
            <button
              class="category-header"
              aria-expanded={expandedAttr}
              aria-controls={categoryId}
              data-collapsible={itemCount > 0 ? 'true' : 'false'}
            >
              {category}
              <span class="chevron" aria-hidden="true">â–¶</span>
            </button>
            <ul class="doc-list" id={categoryId}>
              {docsByCategory[category].map(doc => {
                const docSlug = getBaseSlug(doc.slug);
                const isActive = docSlug === currentSlug;
                return (
                  <li>
                    <a
                      href={`/${currentLang}/docs/${docSlug}`}
                      class={`doc-link ${isActive ? 'active' : ''}`}
                    >
                      {doc.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          </li>
        );
      })}
    </ul>
  </nav>
</aside>

<style>
  /* Sidebar Container */
  .docs-sidebar {
    position: sticky;
    top: calc(3.5rem + 2rem); /* Account for fixed nav height + spacing */
    height: fit-content;
    max-height: calc(100vh - 3.5rem - 4rem); /* Account for nav height and padding */
    overflow-y: visible;
  }

  .docs-nav {
    padding: 1rem;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }

  .nav-title {
    font-size: 1rem;
    text-transform: uppercase;
    color: #666;
    margin: 0 0 1rem 0;
  }

  .category-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .category-item {
    margin-bottom: 1.5rem;
  }

  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0.5rem 0;
    font-weight: 600;
    color: #333;
    font-size: 0.875rem;
    text-transform: uppercase;
    background: none;
    border: none;
    cursor: pointer;
    margin-bottom: 0.5rem;
  }

  .category-header:hover {
    color: #1A1A1A;
  }

  .category-header:focus-visible {
    outline: 2px solid #1A1A1A;
    outline-offset: 2px;
    border-radius: 2px;
  }

  .chevron {
    display: inline-flex;
    align-items: center;
    font-size: 0.75em;
    margin-left: 0.5rem;
    flex-shrink: 0;
  }

  .category-item[data-is-active="true"] .category-header {
    color: #1A1A1A;
  }

  /* Collapsed state */
  .category-item[aria-expanded="false"] .chevron {
    transform: rotate(-90deg);
  }

  .category-item[aria-expanded="false"] .doc-list {
    max-height: 0;
    overflow: hidden;
  }

  .doc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 9999px;
  }

  .doc-list li {
    margin-bottom: 0.5rem;
  }

  .doc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    color: #1A1A1A;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .doc-link:hover {
    background-color: #F5F5F7;
    text-decoration: underline;
  }

  .doc-link.active {
    background-color: #1A1A1A;
    color: white;
    font-weight: 500;
  }

  .doc-link.active:hover {
    background-color: #000000;
    text-decoration: none;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .docs-sidebar {
      position: static;
      max-height: none;
    }
  }
</style>

<script is:inline>
  (function() {
    // Prevent multiple initialization
    if (window.rediaccDocsSidebarInitialized) return;
    window.rediaccDocsSidebarInitialized = true;

    /**
     * Set collapsed/expanded state of a category
     */
    function setCollapsedState(categoryItem, isCollapsed) {
      const button = categoryItem.querySelector('.category-header');
      if (!button) return;

      if (isCollapsed) {
        button.setAttribute('aria-expanded', 'false');
        categoryItem.setAttribute('aria-expanded', 'false');
      } else {
        button.setAttribute('aria-expanded', 'true');
        categoryItem.setAttribute('aria-expanded', 'true');
      }
    }

    /**
     * Initialize collapsible category menus
     */
    function initCollapsibleCategories() {
      const categoryItems = document.querySelectorAll('[data-category][data-item-count]');

      categoryItems.forEach(item => {
        // Skip if already initialized
        if (item.dataset.initialized === 'true') return;
        item.dataset.initialized = 'true';

        const button = item.querySelector('.category-header');
        const category = item.dataset.category;
        const itemCount = parseInt(item.dataset.itemCount, 10);
        const isActive = item.dataset.isActive === 'true';

        if (!button) return;

        // Check sessionStorage for saved state
        const storageKey = `rediacc_docs_cat_${category}`;
        const savedState = sessionStorage.getItem(storageKey);

        if (savedState !== null) {
          // Apply saved state
          const isExpanded = savedState === 'true';
          setCollapsedState(item, !isExpanded);
        }
        // Otherwise, keep the HTML's initial state (no flash)

        // Click handler
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const currentExpanded = item.getAttribute('aria-expanded') === 'true';
          const newExpanded = !currentExpanded;

          setCollapsedState(item, !newExpanded);
          sessionStorage.setItem(storageKey, newExpanded ? 'true' : 'false');
        });

        // Keyboard navigation
        button.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            button.click();
          }
        });
      });
    }

    // Initialize on various events
    function init() {
      initCollapsibleCategories();
    }

    // Astro View Transitions support
    document.addEventListener('astro:page-load', init);

    // Initial load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
